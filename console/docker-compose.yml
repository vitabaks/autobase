---
services:
  autobase-console-api:
    image: autobase/console_api:2.6.0
    container_name: autobase-console-api
    healthcheck:
      test: ["CMD", "curl", "-fsS",
            "-H", "accept: application/json",
            "-H", "Authorization: Bearer ${AUTH_TOKEN}",
            "http://localhost:8080/api/v1/version"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    depends_on:
      autobase-console-db:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/ansible:/tmp/ansible
    environment:
      - PG_CONSOLE_AUTHORIZATION_TOKEN=${AUTH_TOKEN}
      - PG_CONSOLE_LOGGER_LEVEL=${PG_CONSOLE_LOGGER_LEVEL:-INFO}
      - PG_CONSOLE_DB_HOST=autobase-console-db
    networks:
      - autobase

  autobase-console-ui:
    image: autobase/console_ui:2.6.0
    container_name: autobase-console-ui
    ports:
      - 80:80
    healthcheck:
      test: [ "CMD", "curl", "http://localhost:80/" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    depends_on:
      autobase-console-api:
        condition: service_healthy
    environment:
      - PG_CONSOLE_AUTHORIZATION_TOKEN=${AUTH_TOKEN}
      - PG_CONSOLE_API_HOST=autobase-console-api
      - PG_CONSOLE_DBDESK_URL=${DBDESK_URL:-http://localhost:9876}
      - PG_CONSOLE_DBDESK_HOST_REWRITE=${DBDESK_HOST_REWRITE:-}
    networks:
      - autobase

  autobase-console-db:
    image: autobase/console_db:2.6.0
    container_name: autobase-console-db
    healthcheck:
      test: pg_isready -U postgres -h 127.0.0.1
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    volumes:
      - console_postgres:/var/lib/postgresql
    networks:
      - autobase

  dbdesk-studio:
    image: docker.io/anuraggoswami/dbdesk-studio:1.0.0
    container_name: dbdesk-studio
    ports:
      - 9876:9876  # nginx (frontend + /api/ proxy); Express listens internally on PORT
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:6789/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    environment:
      - PORT=6789
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost}
      - NODE_ENV=production
    networks:
      - autobase

volumes:
  console_postgres:
    name: console_postgres

networks:
  autobase:
    name: autobase
