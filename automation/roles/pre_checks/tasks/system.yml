---
# https://www.postgresql.org/docs/current/kernel-resources.html#SYSTEMD-REMOVEIPC
#
# Configure systemd RemoveIPC=no to prevent errors like:
# WARNING: could not remove shared memory segment "/PostgreSQL.1450751626": No such file or directory
# FATAL: could not open shared memory segment "/PostgreSQL.3317458760": No such file or directory

- name: Ensure RemoveIPC is disabled (RemoveIPC=no in logind.conf)
  community.general.ini_file:
    path: /etc/systemd/logind.conf
    section: Login
    option: RemoveIPC
    value: "no"
    create: true
    backup: true
  register: removeipc_result

- name: Restart systemd-logind service
  ansible.builtin.systemd:
    name: systemd-logind
    masked: false
    state: restarted
  when:
    - removeipc_result.changed
    - ansible_service_mgr == "systemd"

# Ubuntu Server installs 'unattended-upgrades' by default.
# When packages are upgraded, the 'needrestart' tool automatically restarts
# services using upgraded libraries, including Patroni, causing unexpected cluster failovers.
- name: Disable unattended-upgrades to prevent automatic service restarts
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    masked: false
  loop:
    - apt-daily-upgrade.timer
    - apt-daily.timer
    - apt-daily-upgrade.service
    - apt-daily.service
    - unattended-upgrades.service
  loop_control:
    label: "{{ item }}"
  when:
    - ansible_os_family == "Debian"
    - ansible_service_mgr == "systemd"
    - disable_unattended_upgrades | bool
  failed_when: false
