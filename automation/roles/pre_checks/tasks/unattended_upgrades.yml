---
# Disable Ubuntu's unattended-upgrades to prevent automatic service restarts
#
# Ubuntu Server installs 'unattended-upgrades' by default.
# When packages are upgraded, the 'needrestart' tool automatically restarts
# services using upgraded libraries, including Patroni, causing unexpected
# cluster failovers.

- name: Disable apt-daily-upgrade.timer (prevents automatic package upgrades)
  ansible.builtin.systemd:
    name: apt-daily-upgrade.timer
    state: stopped
    enabled: false
    masked: false
  when:
    - ansible_os_family == "Debian"
    - ansible_service_mgr == "systemd"
  failed_when: false

- name: Disable apt-daily.timer (prevents automatic package updates)
  ansible.builtin.systemd:
    name: apt-daily.timer
    state: stopped
    enabled: false
    masked: false
  when:
    - ansible_os_family == "Debian"
    - ansible_service_mgr == "systemd"
  failed_when: false

- name: Disable unattended-upgrades.service (prevents automatic upgrades)
  ansible.builtin.systemd:
    name: unattended-upgrades.service
    state: stopped
    enabled: false
    masked: false
  when:
    - ansible_os_family == "Debian"
    - ansible_service_mgr == "systemd"
  failed_when: false
