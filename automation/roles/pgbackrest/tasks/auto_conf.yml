# yamllint disable rule:line-length
---
# AWS S3 bucket (if 'cloud_provider=aws')
- name: "Set variable 'pgbackrest_conf' for backup in AWS S3 bucket"
  ansible.builtin.set_fact:
    pgbackrest_conf:
      global:
        - { option: "log-level-file", value: "detail" }
        - { option: "log-path", value: "/var/log/pgbackrest" }
        - { option: "repo1-type", value: "s3" }
        - { option: "repo1-path", value: "{{ pgbackrest_repo_path | default('/pgbackrest') }}" }
        - { option: "repo1-s3-key", value: "{{ pgbackrest_s3_key | default(lookup('ansible.builtin.env', 'AWS_ACCESS_KEY_ID')) }}" }
        - { option: "repo1-s3-key-secret", value: "{{ pgbackrest_s3_key_secret | default(lookup('ansible.builtin.env', 'AWS_SECRET_ACCESS_KEY')) }}" }
        - { option: "repo1-s3-bucket", value: "{{ pgbackrest_s3_bucket | default(aws_s3_bucket_name | default(patroni_cluster_name + '-backup')) }}" }
        - {
            option: "repo1-s3-endpoint",
            value: "{{ pgbackrest_s3_endpoint | default('s3.' + (aws_s3_bucket_region | default(server_location)) + '.amazonaws.com') }}",
          }
        - { option: "repo1-s3-region", value: "{{ pgbackrest_s3_region | default(aws_s3_bucket_region | default(server_location)) }}" }
        - { option: "repo1-retention-full", value: "{{ pgbackrest_retention_full | default('4') }}" }
        - { option: "repo1-retention-archive", value: "{{ pgbackrest_retention_archive | default('4') }}" }
        - { option: "repo1-retention-archive-type", value: "{{ pgbackrest_retention_archive_type | default('full') }}" }
        - { option: "repo1-bundle", value: "y" }
        - { option: "repo1-block", value: "y" }
        - { option: "start-fast", value: "y" }
        - { option: "stop-auto", value: "y" }
        - { option: "link-all", value: "y" }
        - { option: "resume", value: "n" }
        - { option: "archive-async", value: "y" }
        - { option: "archive-get-queue-max", value: "1GiB" }
        - { option: "spool-path", value: "/var/spool/pgbackrest" }
        - { option: "process-max", value: "{{ pgbackrest_process_max | default([ansible_processor_vcpus | int // 2, 1] | max) }}" }
        - { option: "backup-standby", value: "{{ 'y' if groups['postgres_cluster'] | length > 1 else 'n' }}" }
      stanza:
        - { option: "log-level-console", value: "info" }
        - { option: "recovery-option", value: "recovery_target_action=promote" }
        - { option: "pg1-path", value: "{{ postgresql_data_dir }}" }
  delegate_to: localhost
  run_once: true # noqa run-once
  no_log: true # do not output contents to the ansible log
  when: cloud_provider | default('') | lower == 'aws'

# GCS Bucket (if 'cloud_provider=gcp')
- name: "Set variable 'pgbackrest_conf' for backup in GCS Bucket"
  ansible.builtin.set_fact:
    pgbackrest_conf:
      global:
        - { option: "log-level-file", value: "detail" }
        - { option: "log-path", value: "/var/log/pgbackrest" }
        - { option: "repo1-type", value: "gcs" }
        - { option: "repo1-path", value: "{{ pgbackrest_repo_path | default('/pgbackrest') }}" }
        - { option: "repo1-gcs-key", value: "{{ pgbackrest_gcs_key | default(postgresql_home_dir + '/gcs-key.json') }}" }
        - { option: "repo1-gcs-bucket", value: "{{ pgbackrest_gcs_bucket | default(gcp_bucket_name | default(patroni_cluster_name + '-backup')) }}" }
        - { option: "repo1-retention-full", value: "{{ pgbackrest_retention_full | default('4') }}" }
        - { option: "repo1-retention-archive", value: "{{ pgbackrest_retention_archive | default('4') }}" }
        - { option: "repo1-retention-archive-type", value: "{{ pgbackrest_retention_archive_type | default('full') }}" }
        - { option: "repo1-bundle", value: "y" }
        - { option: "repo1-block", value: "y" }
        - { option: "start-fast", value: "y" }
        - { option: "stop-auto", value: "y" }
        - { option: "link-all", value: "y" }
        - { option: "resume", value: "n" }
        - { option: "archive-async", value: "y" }
        - { option: "archive-get-queue-max", value: "1GiB" }
        - { option: "spool-path", value: "/var/spool/pgbackrest" }
        - { option: "process-max", value: "{{ pgbackrest_process_max | default([ansible_processor_vcpus | int // 2, 1] | max) }}" }
        - { option: "backup-standby", value: "{{ 'y' if groups['postgres_cluster'] | length > 1 else 'n' }}" }
      stanza:
        - { option: "log-level-console", value: "info" }
        - { option: "recovery-option", value: "recovery_target_action=promote" }
        - { option: "pg1-path", value: "{{ postgresql_data_dir }}" }
  no_log: true # do not output contents to the ansible log
  when: cloud_provider | default('') | lower == 'gcp'

# Azure Blob Storage (if 'cloud_provider=azure')
- name: "Set variable 'pgbackrest_conf' for backup in Azure Blob Storage"
  ansible.builtin.set_fact:
    pgbackrest_conf:
      global:
        - { option: "log-level-file", value: "detail" }
        - { option: "log-path", value: "/var/log/pgbackrest" }
        - { option: "repo1-type", value: "azure" }
        - { option: "repo1-path", value: "{{ pgbackrest_repo_path | default('/pgbackrest') }}" }
        - { option: "repo1-azure-key", value: "{{ pgbackrest_azure_key | default(hostvars['localhost']['azure_storage_account_key'] | default('')) }}" }
        - { option: "repo1-azure-key-type", value: "{{ pgbackrest_azure_key_type | default('shared') }}" }
        - {
            option: "repo1-azure-account",
            value: "{{ pgbackrest_azure_account | default(azure_blob_storage_account_name | default(patroni_cluster_name | lower | replace('-', '') | truncate(24, true, ''))) }}",
          }
        - {
            option: "repo1-azure-container",
            value: "{{ pgbackrest_azure_container | default(azure_blob_storage_name | default(patroni_cluster_name + '-backup')) }}",
          }
        - { option: "repo1-retention-full", value: "{{ pgbackrest_retention_full | default('4') }}" }
        - { option: "repo1-retention-archive", value: "{{ pgbackrest_retention_archive | default('4') }}" }
        - { option: "repo1-retention-archive-type", value: "{{ pgbackrest_retention_archive_type | default('full') }}" }
        - { option: "repo1-bundle", value: "y" }
        - { option: "repo1-block", value: "y" }
        - { option: "start-fast", value: "y" }
        - { option: "stop-auto", value: "y" }
        - { option: "link-all", value: "y" }
        - { option: "resume", value: "n" }
        - { option: "archive-async", value: "y" }
        - { option: "archive-get-queue-max", value: "1GiB" }
        - { option: "spool-path", value: "/var/spool/pgbackrest" }
        - { option: "process-max", value: "{{ pgbackrest_process_max | default([ansible_processor_vcpus | int // 2, 1] | max) }}" }
        - { option: "backup-standby", value: "{{ 'y' if groups['postgres_cluster'] | length > 1 else 'n' }}" }
      stanza:
        - { option: "log-level-console", value: "info" }
        - { option: "recovery-option", value: "recovery_target_action=promote" }
        - { option: "pg1-path", value: "{{ postgresql_data_dir }}" }
  no_log: true # do not output contents to the ansible log
  when: cloud_provider | default('') | lower == 'azure'

# DigitalOcean Spaces Object Storage (if 'cloud_provider=digitalocean')
# Note: requires the Spaces access keys "AWS_ACCESS_KEY_ID" and "AWS_SECRET_ACCESS_KEY" (https://cloud.digitalocean.com/account/api/spaces)
- name: "Set variable 'pgbackrest_conf' for backup in DigitalOcean Spaces Object Storage"
  ansible.builtin.set_fact:
    pgbackrest_conf:
      global:
        - { option: "log-level-file", value: "detail" }
        - { option: "log-path", value: "/var/log/pgbackrest" }
        - { option: "repo1-type", value: "s3" }
        - { option: "repo1-path", value: "{{ pgbackrest_repo_path | default('/pgbackrest') }}" }
        - { option: "repo1-s3-key", value: "{{ pgbackrest_s3_key | default(digital_ocean_spaces_access_key | default(AWS_ACCESS_KEY_ID | default(''))) }}" }
        - { option: "repo1-s3-key-secret", value: "{{ pgbackrest_s3_key_secret | default(digital_ocean_spaces_secret_key | default(AWS_SECRET_ACCESS_KEY | default(''))) }}" }
        - { option: "repo1-s3-bucket", value: "{{ pgbackrest_s3_bucket | default(digital_ocean_spaces_name | default(patroni_cluster_name + '-backup')) }}" }
        - {
            option: "repo1-s3-endpoint",
            value: "{{ pgbackrest_s3_endpoint | default('https://' + (digital_ocean_spaces_region | default(default_region)) + '.digitaloceanspaces.com') }}",
          }
        - { option: "repo1-s3-region", value: "{{ pgbackrest_s3_region | default(digital_ocean_spaces_region | default(default_region)) }}" }
        - { option: "repo1-s3-uri-style", value: "{{ pgbackrest_s3_uri_style | default('path') }}" }
        - { option: "repo1-retention-full", value: "{{ pgbackrest_retention_full | default('4') }}" }
        - { option: "repo1-retention-archive", value: "{{ pgbackrest_retention_archive | default('4') }}" }
        - { option: "repo1-retention-archive-type", value: "{{ pgbackrest_retention_archive_type | default('full') }}" }
        - { option: "repo1-bundle", value: "y" }
        - { option: "repo1-block", value: "y" }
        - { option: "start-fast", value: "y" }
        - { option: "stop-auto", value: "y" }
        - { option: "link-all", value: "y" }
        - { option: "resume", value: "n" }
        - { option: "archive-async", value: "y" }
        - { option: "archive-get-queue-max", value: "1GiB" }
        - { option: "spool-path", value: "/var/spool/pgbackrest" }
        - { option: "process-max", value: "{{ pgbackrest_process_max | default([ansible_processor_vcpus | int // 2, 1] | max) }}" }
        - { option: "backup-standby", value: "{{ 'y' if groups['postgres_cluster'] | length > 1 else 'n' }}" }
      stanza:
        - { option: "log-level-console", value: "info" }
        - { option: "recovery-option", value: "recovery_target_action=promote" }
        - { option: "pg1-path", value: "{{ postgresql_data_dir }}" }
  vars:
    default_region: "{{ (server_location in ['nyc1', 'nyc2']) | ternary('nyc3', server_location) }}"
  no_log: true # do not output contents to the ansible log
  when: cloud_provider | default('') | lower == 'digitalocean'

# Hetzner Object Storage (if 'cloud_provider=hetzner')
- name: "Set variable 'pgbackrest_conf' for backup in Hetzner Object Storage (S3 bucket)"
  ansible.builtin.set_fact:
    pgbackrest_conf:
      global:
        - { option: "log-level-file", value: "detail" }
        - { option: "log-path", value: "/var/log/pgbackrest" }
        - { option: "repo1-type", value: "s3" }
        - { option: "repo1-path", value: "{{ pgbackrest_repo_path | default('/pgbackrest') }}" }
        - { option: "repo1-s3-key", value: "{{ pgbackrest_s3_key | default(hetzner_object_storage_access_key | default('')) }}" }
        - { option: "repo1-s3-key-secret", value: "{{ pgbackrest_s3_key_secret | default(hetzner_object_storage_secret_key | default('')) }}" }
        - { option: "repo1-s3-bucket", value: "{{ pgbackrest_s3_bucket | default(hetzner_object_storage_name | default(patroni_cluster_name + '-backup')) }}" }
        - {
            option: "repo1-s3-endpoint",
            value: "{{ pgbackrest_s3_endpoint | default(hetzner_object_storage_endpoint | default('https://' + (hetzner_object_storage_region | default(default_region)) + '.your-objectstorage.com')) }}",
          }
        - { option: "repo1-s3-region", value: "{{ pgbackrest_s3_region | default(hetzner_object_storage_region | default(default_region)) }}" }
        - { option: "repo1-s3-uri-style", value: "{{ pgbackrest_s3_uri_style | default('path') }}" }
        - { option: "repo1-retention-full", value: "{{ pgbackrest_retention_full | default('4') }}" }
        - { option: "repo1-retention-archive", value: "{{ pgbackrest_retention_archive | default('4') }}" }
        - { option: "repo1-retention-archive-type", value: "{{ pgbackrest_retention_archive_type | default('full') }}" }
        - { option: "repo1-bundle", value: "y" }
        - { option: "repo1-block", value: "y" }
        - { option: "start-fast", value: "y" }
        - { option: "stop-auto", value: "y" }
        - { option: "link-all", value: "y" }
        - { option: "resume", value: "n" }
        - { option: "archive-async", value: "y" }
        - { option: "archive-get-queue-max", value: "1GiB" }
        - { option: "spool-path", value: "/var/spool/pgbackrest" }
        - { option: "process-max", value: "{{ pgbackrest_process_max | default([ansible_processor_vcpus | int // 2, 1] | max) }}" }
        - { option: "backup-standby", value: "{{ 'y' if groups['postgres_cluster'] | length > 1 else 'n' }}" }
      stanza:
        - { option: "log-level-console", value: "info" }
        - { option: "recovery-option", value: "recovery_target_action=promote" }
        - { option: "pg1-path", value: "{{ postgresql_data_dir }}" }
  vars:
    default_region: "{{ (server_location in ['hel1', 'fsn1', 'nbg1']) | ternary(server_location, 'nbg1') }}"
  delegate_to: localhost
  run_once: true # noqa run-once
  no_log: true # do not output contents to the ansible log
  when: cloud_provider | default('') | lower == 'hetzner'
