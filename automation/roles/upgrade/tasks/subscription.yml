---
# Blue-green upgrade method: Create subscriptions on the target cluster
# for logical replication from the source cluster.

# One subscription (if pg_publication_count = 1)
- block:
    - name: (TARGET) Create a subscription for logical replication using a previously created slot
      ansible.builtin.shell: >-
        {{ psql_command }} -tAXc "drop subscription if exists {{ pg_subscription_name }}";
        {{ psql_command }} -tAXc "create subscription {{ pg_subscription_name }}
        connection 'host={{ hostvars[groups['source_primary'][0]]['inventory_hostname'] }}
        port={{ pg_source_port }} user={{ patroni_superuser_username }} dbname={{ dbname }}'
        publication {{ pg_publication_name }}
        with (copy_data = false, create_slot = false, slot_name = '{{ pg_subscription_slot_name }}')"
      when:
        - inventory_hostname in groups['target_cluster']
        - patroni_cluster_leader

    - name: '(SOURCE) Make sure that logical replication is active'
      ansible.builtin.command: >-
        {{ psql_command }} -tAXc "select active
        from pg_replication_slots where slot_name = '{{ pg_subscription_slot_name }}'"
      register: pg_logical_slot_state
      changed_when: false
      until: pg_logical_slot_state.stdout == "t"
      retries: 30
      delay: 2
      when:
        - inventory_hostname in groups['source_cluster']
        - patroni_cluster_leader

    - name: '(SOURCE) Check the logical replication lag'
      ansible.builtin.command: >-
        {{ psql_command }} -tAXc "select pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)
        from pg_replication_slots
        where slot_name = '{{ pg_subscription_slot_name }}'"
      register: pg_logical_slot_lag_bytes
      changed_when: false
      when:
        - inventory_hostname in groups['source_cluster']
        - patroni_cluster_leader

    - name: Result of setting up logical replication
      ansible.builtin.debug:
        msg: >-
          The logical replication setup is completed. Current replication lag:
          {{ pg_logical_slot_lag_bytes.stdout | int | human_readable }}
      when:
        - inventory_hostname in groups['source_cluster']
        - patroni_cluster_leader
  vars:
    psql_command: "{{ pg_old_bindir }}/psql -h 127.0.0.1 -p {{ postgresql_port }} -U {{ patroni_superuser_username }} -d {{ dbname }}"
  environment:
    PGPASSWORD: "{{ patroni_superuser_password }}"
  when: pg_publication_count | int == 1

# Multiple subscriptions (if pg_publication_count > 1)
- block:
    # Create multiple subscriptions (for each slot/publication)
    - name: "(TARGET) Create a subscription for logical replication using a previously created slot"
      ansible.builtin.shell: >-
        {{ psql_command }} -tAXc "drop subscription if exists {{ pg_subscription_name }}_{{ '%02d' % (idx + 1) }}";
        {{ psql_command }} -tAXc "create subscription {{ pg_subscription_name }}_{{ '%02d' % (idx + 1) }}
        connection 'host={{ hostvars[groups['source_primary'][0]]['inventory_hostname'] }}
        port={{ pg_source_port }} user={{ patroni_superuser_username }} dbname={{ dbname }}'
        publication {{ pg_publication_name }}_{{ '%02d' % (idx + 1) }}
        with (copy_data = false, create_slot = false, slot_name = '{{ pg_subscription_slot_name }}_{{ '%02d' % (idx + 1) }}')"
      loop: "{{ range(0, pg_publication_count | int) | list }}"
      loop_control:
        index_var: idx
        label: "{{ pg_subscription_name }}_{{ '%02d' % (idx + 1) }}"
      when:
        - inventory_hostname in groups['target_cluster']
        - patroni_cluster_leader

    # Check the logical replication state for each slot
    - name: '(SOURCE) Make sure that logical replication is active'
      ansible.builtin.command: >-
        {{ psql_command }} -tAXc "select active from pg_replication_slots
        where slot_name = '{{ pg_subscription_slot_name }}_{{ '%02d' % (idx + 1) }}'"
      register: pg_logical_slot_state
      changed_when: false
      until: pg_logical_slot_state.stdout == "t"
      retries: 30
      delay: 2
      loop: "{{ range(0, pg_publication_count | int) | list }}"
      loop_control:
        index_var: idx
        label: "{{ pg_subscription_slot_name }}_{{ '%02d' % (idx + 1) }}"
      when:
        - patroni_cluster_leader
        - inventory_hostname in groups['source_cluster']

    # Check the logical replication lag for each slot
    - name: '(SOURCE) Check the logical replication lag'
      ansible.builtin.command: >-
        {{ psql_command }} -Xc "select slot_name, pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn) as lag_bytes
        from pg_replication_slots
        where slot_name = '{{ pg_subscription_slot_name }}_{{ '%02d' % (idx + 1) }}'"
      register: pg_logical_slot_lag_bytes
      changed_when: false
      loop: "{{ range(0, pg_publication_count | int) | list }}"
      loop_control:
        index_var: idx
        label: "{{ pg_subscription_slot_name }}_{{ '%02d' % (idx + 1) }}"
      when:
        - inventory_hostname in groups['source_cluster']
        - patroni_cluster_leader

    # Display the logical replication lag for each slot
    - name: Result of setting up logical replication
      ansible.builtin.debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ pg_logical_slot_lag_bytes.results }}"
      loop_control:
        index_var: idx
        label: "{{ pg_subscription_slot_name }}_{{ '%02d' % (idx + 1) }}"
      when:
        - inventory_hostname in groups['source_cluster']
        - patroni_cluster_leader
  vars:
    psql_command: "{{ pg_old_bindir }}/psql -h 127.0.0.1 -p {{ postgresql_port }} -U {{ patroni_superuser_username }} -d {{ dbname }}"
  environment:
    PGPASSWORD: "{{ patroni_superuser_password }}"
  when: pg_publication_count | int > 1
