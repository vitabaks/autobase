---
# Prepare PgBouncer config to redirect traffic to the target cluster (blue-green deployment method)

- name: "Pre-Check error. Fail if replica counts mismatch between source and target clusters"
  ansible.builtin.fail:
    msg: >-
      Replica count mismatch:
      source secondary={{ (groups.get('source_secondary', []) | length) }},
      target secondary={{ (groups.get('secondary', []) | length) }}
  when:
    - inventory_hostname in groups.get('source_primary', [])
    - (groups.get('secondary', []) | length) != (groups.get('source_secondary', []) | length)

- name: Prepare PgBouncer configuration to redirect primary traffic
  ansible.builtin.replace:
    path: "{{ pgbouncer_conf_dir }}/pgbouncer.ini"
    regexp: '(?m)^(\s*[^#;\n]*\bhost=)[^\s]+'
    replace: '\g<1>{{ target_primary_host_addr }}'
  vars:
    target_primary_host: "{{ (groups.get('primary', []) | first) | default('', true) }}"
    target_primary_host_addr: >-
      {{
        hostvars[target_primary_host].patroni_bind_address
        | default(hostvars[target_primary_host].bind_address, true)
        | default(hostvars[target_primary_host].inventory_hostname, true)
      }}
  when: inventory_hostname in groups.get('source_primary', [])

- name: Prepare PgBouncer configuration to redirect replica traffic
  ansible.builtin.replace:
    path: "{{ pgbouncer_conf_dir }}/pgbouncer.ini"
    regexp: '(?m)^(\s*[^#;\n]*\bhost=)[^\s]+'
    replace: '\g<1>{{ target_secondary_host_addr }}'
  vars:
    source_secondaries: "{{ groups.get('source_secondary', []) | sort }}"
    target_secondaries: "{{ groups.get('secondary', []) | sort }}"
    source_idx: "{{ source_secondaries.index(inventory_hostname) }}"
    target_secondary_host: "{{ target_secondaries[source_idx] }}"
    target_secondary_host_addr: >-
      {{
        hostvars[target_secondary_host].patroni_bind_address
        | default(hostvars[target_secondary_host].bind_address, true)
        | default(hostvars[target_secondary_host].inventory_hostname, true)
      }}
  when: inventory_hostname in groups.get('source_secondary', [])

# if self-signed certificates are used (tls_cert_generate = true)
# Target cluster uses a different CA, so PgBouncer on source may fail to verify TLS when connecting to Postgres on target
# This prevents: "could not accept SSL connection: certificate verify failed"
- name: Temporarily disable TLS from PgBouncer to Postgres during redirect
  ansible.builtin.lineinfile:
    path: "{{ pgbouncer_conf_dir }}/pgbouncer.ini"
    regexp: '^\s*server_tls_sslmode\s*='
    line: "server_tls_sslmode = disable"
  when:
    - tls_cert_generate | default(false) | bool
    - inventory_hostname in groups.get('source_cluster', [])
