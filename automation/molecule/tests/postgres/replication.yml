---
- name: Check PostgreSQL replication status
  community.postgresql.postgresql_query:
    login_host: "127.0.0.1"
    login_port: "{{ postgresql_port }}"
    login_user: "{{ patroni_superuser_username }}"
    login_password: "{{ patroni_superuser_password }}"
    login_db: "postgres"
    query: "SELECT pg_is_in_recovery(), count(*) FROM pg_stat_wal_receiver;"
  register: pg_replication_status
  failed_when: "pg_replication_status.query_result[0].pg_is_in_recovery and pg_replication_status.query_result[0].count == 0"
